# Архитектура проекта DMD Cottage Sheets

## Описание проекта

FastAPI сервис для управления бронированиями недвижимости с интеграцией через webhook, веб-интерфейсом для просмотра и экспорта данных в Excel.

## Структура проекта

```
raznaradki_realty_calendar/
├── app/
│   ├── __init__.py              # Инициализация пакета приложения
│   ├── main.py                  # Главный файл FastAPI приложения
│   ├── config.py                # Конфигурация из .env файла
│   ├── database.py              # Подключение к PostgreSQL и сессии
│   ├── models.py                # SQLAlchemy модели базы данных
│   ├── schemas.py               # Pydantic схемы для валидации данных
│   ├── crud.py                  # CRUD операции для работы с БД
│   ├── auth.py                  # Базовая аутентификация
│   ├── routers/
│   │   ├── __init__.py          # Инициализация пакета роутеров
│   │   ├── webhook.py           # Endpoint для webhook
│   │   └── web.py               # Web UI endpoints
│   ├── static/
│   │   └── js/
│   │       └── bookings.js      # JavaScript для страницы бронирований
│   └── templates/
│       ├── base.html            # Базовый шаблон с Bootstrap
│       ├── login.html           # Страница входа
│       └── bookings.html        # Таблица бронирований
├── logs/                        # Директория для логов
├── cells.json                   # Экспорт таблицы cells из старой БД (для миграции)
├── sheets.json                  # Экспорт таблицы sheets из старой БД (для миграции)
├── migrate_old_data.py          # Скрипт миграции данных из старой БД
├── init_services.py             # Скрипт инициализации базовых услуг
├── .env                         # Переменные окружения (не в git)
├── .env.example                 # Пример переменных окружения
├── .gitignore                   # Файлы, игнорируемые git
├── pyproject.toml               # Зависимости проекта
├── README.md                    # Документация проекта
├── MIGRATION_README.md          # Инструкция по миграции данных из старой БД
└── architecture.md              # Этот файл - описание архитектуры
```

## Описание файлов

### app/main.py
Главный файл приложения FastAPI:
- Создание экземпляра FastAPI приложения
- Настройка логирования через loguru (консоль + файл)
- Lifecycle management (инициализация БД при запуске)
- Подключение статических файлов (/static)
- Подключение роутеров (webhook, web)
- Health check endpoint

### app/config.py
Управление конфигурацией:
- Класс Settings на базе Pydantic для загрузки переменных из .env
- Функция get_settings() с кешированием настроек
- Переменные: DATABASE_URL, ADMIN_USERNAME, ADMIN_PASSWORD, SECRET_KEY

### app/database.py
Настройка подключения к PostgreSQL:
- Создание engine для SQLAlchemy
- Фабрика сессий SessionLocal
- Базовый класс Base для моделей
- Dependency get_db() для получения сессии БД
- Функция init_db() для создания таблиц

### app/models.py
SQLAlchemy модели базы данных:
- **Booking** - модель бронирования с полями:
  - Основные: id, action, status
  - Даты: begin_date, end_date
  - ID связей: realty_id, client_id
  - Финансы: amount, prepayment, payment
  - Время: arrival_time, departure_time
  - Клиент: client_fio, client_phone, client_email
  - Квартира: apartment_title, apartment_address
  - Дополнительно: number_of_days, number_of_nights, notes, checkin_day_comments
  - Флаги: is_delete
  - Временные метки: created_at, updated_at
  - Связи: services (relationship с BookingService)
- **Service** - справочник дополнительных услуг:
  - id: уникальный идентификатор
  - name: название услуги (уникальное)
  - is_active: активна ли услуга
  - created_at, updated_at: временные метки
- **BookingService** - дополнительные услуги к бронированию:
  - id: уникальный идентификатор
  - booking_id: ID бронирования (FK)
  - service_id: ID услуги (FK)
  - price: цена услуги
  - created_at: дата добавления

### app/schemas.py
Pydantic схемы для валидации данных:
- **ServiceCreate** - создание услуги (name)
- **ServiceResponse** - ответ с услугой (id, name, is_active, created_at)
- **BookingServiceCreate** - добавление услуги к бронированию (booking_id, service_id, price)
- **BookingServiceResponse** - ответ с услугой бронирования (id, booking_id, service_id, price, service_name, created_at)
- **ClientSchema** - данные клиента (id, fio, email, phone); игнорирует дополнительные поля
- **ApartmentSchema** - данные квартиры (id, title, address); игнорирует дополнительные поля
- **BookingSchema** - данные бронирования (все поля модели); игнорирует дополнительные поля (payments_with_deleted, url и т.д.)
- **WebhookDataSchema** - обертка для booking; игнорирует дополнительные поля
- **WebhookPayloadSchema** - payload webhook (action, status, data); игнорирует дополнительные поля (changes, crm_entity_id и т.д.)
- **WebhookRequestSchema** - алиас для WebhookPayloadSchema (данные приходят напрямую без обёртки body)

### app/crud.py
CRUD операции для работы с базой данных:
- **create_or_update_booking()** - создает новое или обновляет существующее бронирование
- **mark_booking_as_deleted()** - помечает бронирование как удаленное
- **get_bookings()** - получает список бронирований с фильтрацией по дате:
  - Фильтр по дате выбирает бронирования где указанная дата является датой заселения (begin_date) ИЛИ датой выселения (end_date)
  - Возвращает только не удаленные бронирования
- **get_booking_by_id()** - получает бронирование по ID
- **get_grouped_bookings()** - группирует бронирования по apartment_title и дате для отображения:
  - Использует apartment_title (название квартиры) для поля address
  - Объединяет выселение и заселение на один адрес в одну строку
  - Определяет статус автоматически на основе совпадения дат:
    - Проверяется совпадение filter_date с датами бронирования
    - Если filter_date == end_date → это выселение (checkout)
    - Если filter_date == begin_date → это заселение (checkin)
    - Если обе даты совпадают → Выс/Зас
    - Если filter_date не задан → все бронирования считаются заселением
  - Ключ группировки: (apartment_title, filter_date) - объединяет записи с одним адресом на одну дату
  - Пропускает бронирования, которые не относятся к выбранной дате (не заселение и не выселение)
  - Группирует дубли (например "00) 29" и "00) 29 ДУБЛЬ") вместе и размещает их рядом
  - Сортирует данные: сначала по адресу (алфавитный порядок A-Z, регистронезависимо), затем по дате (новые первыми)
  - Помечает строки флагами для жирных границ: is_first_in_group, is_last_in_group, is_single_row, has_duplicate
  - Жирные границы применяются только к группам дублей (сверху первой и снизу последней строки группы)
  - Между строками дублей внутри группы остаются обычные границы
  - Возвращает словарь с полями: address, date, checkout, checkin, is_first_in_group, is_last_in_group, is_single_row, has_duplicate
- **update_checkin_day_comments()** - обновляет комментарии по оплате и проживанию в день заселения для конкретного бронирования
- **get_all_services()** - получает список всех активных услуг
- **create_service()** - создает новую услугу
- **get_booking_services()** - получает все услуги для конкретного бронирования
- **add_booking_service()** - добавляет услугу к бронированию
- **delete_booking_service()** - удаляет услугу из бронирования
- **get_booking_services_total()** - получает общую сумму услуг для бронирования

### app/auth.py
Система аутентификации:
- **verify_credentials()** - проверка HTTP Basic Auth (для API endpoints)
- **create_session_cookie()** - создание session cookie после входа
- Примечание: для веб-страниц используется функция check_auth() в web.py

### app/routers/webhook.py
Роутер для webhook endpoints:
- **POST /webhook** - прием данных о бронированиях
  - Обрабатывает массив объектов или один объект
  - Поддерживает action: create_booking, update_booking, delete_booking
  - Валидация через Pydantic схемы
  - Сохранение в БД через CRUD функции

### app/routers/web.py
Роутер для веб-интерфейса:
- **check_auth()** - проверка авторизации через cookie (внутренняя функция)
- **GET /** - редирект на /bookings
- **GET /login** - страница входа
- **POST /login** - обработка формы входа
- **GET /logout** - выход из системы
- **GET /bookings** - страница с таблицей бронирований (требует авторизацию)
  - Проверяет авторизацию и редиректит на /login если не авторизован
  - Параметр filter_date для фильтрации: показывает бронирования где выбранная дата является датой заселения ИЛИ выселения
  - Использует get_grouped_bookings() для группировки данных
  - Отображает выселение и заселение в одной строке для одного адреса
  - Редактируемая колонка "Комментарии по оплате и проживанию в день заселения" с автосохранением
  - Колонка "Доп. услуги" с суммой услуг и модальным окном для управления
- **POST /update-checkin-comment** - обновление комментария по оплате и проживанию (требует авторизацию)
  - Принимает booking_id и comments через форму
  - Обновляет поле checkin_day_comments в БД
  - Возвращает JSON с результатом операции
- **GET /services** - получить список всех активных услуг (требует авторизацию)
- **GET /booking-services/{booking_id}** - получить услуги для бронирования (требует авторизацию)
  - Возвращает список услуг и общую сумму
- **POST /booking-services** - добавить услугу к бронированию (требует авторизацию)
  - Принимает booking_id, service_id, price через форму
  - Возвращает JSON с результатом операции
- **DELETE /booking-services/{booking_service_id}** - удалить услугу из бронирования (требует авторизацию)
- **GET /export** - экспорт в Excel (требует авторизацию)
  - Проверяет авторизацию и редиректит на /login если не авторизован
  - Создает Excel файл с помощью openpyxl
  - Использует get_grouped_bookings() для группировки данных
  - Двухуровневая структура заголовков:
    - Уровень 1: Дата заезда (A1:B1), Выселение (C1:E1), Заселение (F1:O1)
    - Уровень 2: Адрес, Статус дома, ФИО (выс), Телефон (выс), Комментарий (выс), ФИО (зас), Телефон (зас), Дата выселения, Кол-во дней, Общая сумма, Предоплата, Доплата, Доп. услуги, Комментарий (зас), Комментарии по оплате и проживанию в день заселения
  - Данные разделены по секциям выселения и заселения
  - Включает сумму дополнительных услуг для каждого бронирования
  - **Стилизация Excel**:
    - Первая строка заголовков: фон rgb(245, 245, 245), жирный шрифт
    - Вторая строка заголовков - цветовое кодирование:
      - "Адрес", "Статус дома": фон rgb(245, 245, 245)
      - Колонки "Выселение" (3-5): бледно-красный (#ffcccc)
      - Колонки "Заселение" (6-15): бледно-зеленый (#ccffcc)
    - Жирные границы (thick): слева от колонок 3 и 6, под второй строкой заголовков
    - **Колонка "Адрес"**: apartment_title в верхнем регистре (UPPERCASE) жирным шрифтом
    - **Колонки "Общая сумма" (10) и "Доплата" (12)**: жирный шрифт для данных
    - **Группировка дублей**: строки с дублями (например "00) 29" и "00) 29 ДУБЛЬ") располагаются рядом и выделяются жирными границами сверху первой строки группы и снизу последней строки группы; внутри группы между дублями границы обычные; одиночные строки без дублей имеют обычные границы
    - Границы для всех ячеек, выравнивание по центру для заголовков
  - Возвращает файл через StreamingResponse

### app/templates/base.html
Базовый HTML шаблон:
- Bootstrap 5 для стилизации
- Bootstrap Icons для иконок
- Навигационная панель
- Блоки для расширения (content, extra_css, extra_js)

### app/templates/login.html
Страница входа:
- Форма с полями username и password
- Отображение ошибок входа
- Наследуется от base.html

### app/static/js/bookings.js
JavaScript для страницы бронирований:
- **Изменение размера столбцов**:
  - Добавляет интерактивные ресайзеры на правые границы заголовков столбцов
  - Сохраняет размеры столбцов в localStorage (ключ: bookings_table_column_widths)
  - Применяет сохраненные размеры при загрузке страницы
  - Стандартные значения ширины столбцов (в пикселях): [97, 100, 90, 152, 167, 99, 120, 100, 100, 100, 111, 83, 77, 141, 146]
  - Нет минимальной ширины столбцов
  - Динамически пересчитывает ширину таблицы на основе суммы ширин всех столбцов
  - Таблица автоматически адаптируется при изменении размера столбцов в реальном времени
  - Функция сброса ширины столбцов к стандартным значениям (resetColumnWidths)
- **Управление комментариями**:
  - Автосохранение комментариев с визуальными уведомлениями
  - Показ/скрытие кнопки сохранения при изменении текста
- **Управление дополнительными услугами**:
  - Форматирование чисел с разделителем тысяч (formatNumber)
  - Загрузка списка доступных услуг
  - Загрузка сумм услуг для всех бронирований
  - Popover с детализацией услуг при наведении
  - Модальное окно для добавления/удаления услуг
  - AJAX запросы для работы с услугами
- **Уведомления**:
  - Показ всплывающих уведомлений (success, danger, warning)
  - Автоматическое скрытие через 3 секунды

### app/templates/bookings.html
Страница с таблицей бронирований:
- Форма фильтрации по дате заезда
- Кнопки: Фильтровать, Сбросить, Экспорт в Excel, Сбросить ширину столбцов
- Таблица с двумя уровнями заголовков (идентична экспорту):
  - Уровень 1: Дата заезда (colspan=2), Выселение (colspan=3), Заселение (colspan=10)
  - Уровень 2: Адрес, Статус дома, ФИО (выс), Телефон (выс), Комментарий (выс), ФИО (зас), Телефон (зас), Дата выселения, Кол-во дней, Общая сумма, Предоплата, Доплата, Доп. услуги, Комментарий (зас), Комментарии по оплате и проживанию в день заселения
- ID скрыт из таблицы
- Даты в формате dd.mm.yyyy
- Статусы: "Заселение", "Выселение", "Выс/Зас"
- Финансовые данные без копеек
- Группировка: данные по одному apartment_title и дате в одной строке
- Секции выселения и заселения отображаются в зависимости от статуса
- Единый формат таблицы для UI и экспорта
- **Изменение размера столбцов**:
  - Каждый столбец можно растягивать/сжимать мышью за правый край заголовка
  - Стандартные значения ширины столбцов: [97, 100, 90, 152, 167, 99, 120, 100, 100, 100, 111, 83, 77, 141, 146]
  - Размеры столбцов сохраняются в localStorage браузера
  - Нет минимальной ширины столбцов
  - Ширина таблицы динамически изменяется на основе суммы ширин всех столбцов
  - Таблица не растянута на всю страницу, имеет точную ширину по содержимому
  - Кнопка "Сбросить ширину столбцов" для возврата к стандартным значениям
- **Стилизация таблицы**:
  - Первая строка заголовков: фон rgb(245, 245, 245)
  - Вторая строка заголовков - цветовое кодирование:
    - "Адрес", "Статус дома": фон rgb(245, 245, 245)
    - Колонки "Выселение": бледно-красный фон (#ffcccc)
    - Колонки "Заселение": бледно-зеленый фон (#ccffcc)
  - Жирные границы (3px): слева от "Выселение", слева от "Заселение", под второй строкой заголовков
  - **Колонки "Общая сумма" и "Доплата"**: жирный шрифт
  - **Группировка дублей**: строки с дублями (например "00) 29" и "00) 29 ДУБЛЬ") располагаются рядом и выделяются жирными границами сверху первой строки группы и снизу последней строки группы; внутри группы между дублями границы обычные; одиночные строки без дублей имеют обычные границы
- **Колонка "Адрес"**: отображает apartment_title в верхнем регистре (UPPERCASE) жирным шрифтом
- **Редактируемая колонка**: "Комментарии по оплате и проживанию в день заселения" с textarea и кнопкой сохранения
- **Колонка "Доп. услуги"**:
  - Отображает общую сумму дополнительных услуг в формате с разделителем тысяч (10,000) без значка рубля
  - При клике открывает модальное окно для управления услугами
  - Модальное окно содержит:
    - Форму добавления услуги (выбор из выпадающего списка, ввод цены)
    - Список добавленных услуг с возможностью удаления (цены в формате с разделителем, без ₽)
    - Общую сумму всех услуг (в формате с разделителем, без ₽)
- Подключает внешний JavaScript файл bookings.js

## API Endpoints

### Webhook API

#### POST /webhook
Прием webhook данных о бронированиях.

**Request Body (массив или один объект):**
```json
[{
  "action": "create_booking",
  "status": "booked",
  "data": {
    "booking": {
      "id": 122913631,
      "begin_date": "2025-10-13",
      "end_date": "2025-10-14",
      "client": {...},
      "apartment": {...},
      ...
    }
  }
}]
```

**Response:**
```json
{
  "status": "success",
  "processed": 1,
  "results": [...]
}
```

### Web API

#### GET /
Редирект на /bookings

#### GET /login
Страница входа

#### POST /login
Обработка формы входа
- Form data: username, password

#### GET /logout
Выход из системы

#### GET /bookings
Страница бронирований
- Query параметр: `filter_date` (YYYY-MM-DD) - показывает бронирования где указанная дата является датой заселения ИЛИ выселения
- Требует: авторизация через cookie

#### POST /update-checkin-comment
Обновление комментария по оплате и проживанию
- Form data: `booking_id`, `comments`
- Требует: авторизация через cookie
- Response: JSON `{"status": "success", "message": "..."}`

#### GET /services
Получить список всех активных услуг
- Требует: авторизация через cookie
- Response: JSON `{"services": [{"id": 1, "name": "Услуга"}]}`

#### GET /booking-services/{booking_id}
Получить услуги для конкретного бронирования
- Path параметр: `booking_id`
- Требует: авторизация через cookie
- Response: JSON `{"services": [...], "total": 1000.0}`

#### POST /booking-services
Добавить услугу к бронированию
- Form data: `booking_id`, `service_id`, `price`
- Требует: авторизация через cookie
- Response: JSON `{"status": "success", "message": "...", "id": 1}`

#### DELETE /booking-services/{booking_service_id}
Удалить услугу из бронирования
- Path параметр: `booking_service_id`
- Требует: авторизация через cookie
- Response: JSON `{"status": "success", "message": "..."}`

#### GET /export
Экспорт в Excel
- Query параметр: `filter_date` (YYYY-MM-DD)
- Требует: авторизация через cookie
- Response: Excel файл

#### GET /health
Health check endpoint
```json
{"status": "ok", "service": "DMD Cottage Sheets"}
```

## База данных

### Таблица: bookings

| Поле | Тип | Описание |
|------|-----|----------|
| id | Integer (PK) | ID бронирования из webhook |
| action | String | Действие: create_booking, update_booking, delete_booking |
| status | String | Статус: booked, deleted |
| begin_date | Date | Дата заезда (индексируется) |
| end_date | Date | Дата выезда |
| realty_id | Integer | ID недвижимости |
| client_id | Integer | ID клиента |
| amount | Numeric(10,2) | Общая сумма |
| prepayment | Numeric(10,2) | Предоплата |
| payment | Numeric(10,2) | Оплата |
| arrival_time | Time | Время заселения |
| departure_time | Time | Время выселения |
| notes | String | Комментарии |
| checkin_day_comments | String | Комментарии по оплате и проживанию в день заселения (редактируемое поле) |
| client_fio | String | ФИО клиента |
| client_phone | String | Телефон клиента |
| client_email | String | Email клиента |
| apartment_title | String | Название квартиры |
| apartment_address | String | Адрес квартиры |
| number_of_days | Integer | Количество дней |
| number_of_nights | Integer | Количество ночей |
| is_delete | Boolean | Флаг удаления |
| created_at | DateTime | Дата создания записи |
| updated_at | DateTime | Дата обновления записи |
| webhook_created_at | DateTime | Дата создания из webhook |
| webhook_updated_at | DateTime | Дата обновления из webhook |

### Таблица: services

| Поле | Тип | Описание |
|------|-----|----------|
| id | Integer (PK) | Уникальный идентификатор |
| name | String (Unique) | Название услуги |
| is_active | Boolean | Активна ли услуга |
| created_at | DateTime | Дата создания |
| updated_at | DateTime | Дата обновления |

### Таблица: booking_services

| Поле | Тип | Описание |
|------|-----|----------|
| id | Integer (PK) | Уникальный идентификатор |
| booking_id | Integer (FK -> bookings.id) | ID бронирования (индексируется) |
| service_id | Integer (FK -> services.id) | ID услуги (индексируется) |
| price | Numeric(10,2) | Цена услуги |
| created_at | DateTime | Дата добавления |

**Связи:**
- bookings.services -> booking_services (one-to-many, cascade delete)
- services.booking_services -> booking_services (one-to-many, cascade delete)
- booking_services.booking -> bookings (many-to-one)
- booking_services.service -> services (many-to-one)

## Зависимости

- **fastapi** - веб-фреймворк
- **uvicorn** - ASGI сервер
- **sqlalchemy** - ORM для работы с БД
- **psycopg2-binary** - драйвер PostgreSQL
- **python-dotenv** - загрузка переменных из .env
- **pydantic-settings** - управление настройками
- **jinja2** - шаблонизатор для HTML
- **python-multipart** - обработка форм
- **openpyxl** - создание Excel файлов
- **loguru** - логирование

## Переменные окружения (.env)

```env
DATABASE_URL=postgresql://user:password@localhost:5432/realty_calendar
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin
SECRET_KEY=your-secret-key-change-this-in-production
```

## Логирование

Используется библиотека **loguru**:
- Вывод в консоль с цветной подсветкой
- Запись в файл `logs/app.log`
- Ротация файлов при достижении 10 MB
- Хранение логов 30 дней
- Сжатие старых логов в zip

## Безопасность

- Базовая HTTP Basic Auth для проверки учетных данных
- Session cookie для поддержания сеанса
- HTTPOnly cookies для защиты от XSS
- Учетные данные хранятся в .env файле
- .env файл в .gitignore

## Использование

### Запуск приложения

```bash
# Установка uv (если еще не установлен)
curl -LsSf https://astral.sh/uv/install.sh | sh

# Синхронизация зависимостей
uv sync

# Настройка .env файла (уже создан, отредактируйте при необходимости)
vim .env

# Запуск сервера
uv run raznaradki_main.py

# Или через скрипт
./run.sh
```

Приложение будет доступно на `http://localhost:8000`

### Доступ к веб-интерфейсу

1. Открыть `http://localhost:8000`
2. Войти с учетными данными из .env (по умолчанию admin/admin)
3. Просматривать и фильтровать бронирования
4. Экспортировать в Excel

### Отправка webhook

```bash
curl -X POST http://localhost:8000/webhook \
  -H "Content-Type: application/json" \
  -d @create_booking.json
```

## Развертывание

### Локальное развертывание

1. Настроить PostgreSQL базу данных
2. Создать .env файл с реальными учетными данными
3. Установить зависимости: `pip install -e .`
4. Запустить приложение: `./run.sh` или `python -m app.main`
5. Таблицы создадутся автоматически при старте

### Docker развертывание

Самый простой способ запуска с PostgreSQL:

```bash
# Запуск всех сервисов
docker-compose up -d

# Просмотр логов
docker-compose logs -f app

# Остановка
docker-compose down
```

Приложение будет доступно на `http://localhost:8000`

### Production развертывание

1. Используйте управляемую PostgreSQL базу данных
2. Настройте .env с безопасными учетными данными
3. Используйте reverse proxy (nginx)
4. Включите SSL/TLS
5. Настройте firewall
6. Используйте process manager (systemd, supervisor)
7. Настройте мониторинг и алертинг

## Дополнительные файлы

### run.sh
Скрипт для запуска приложения:
- Проверяет наличие .env
- Устанавливает зависимости при необходимости
- Запускает приложение

### test_webhook.sh
Скрипт для тестирования webhook endpoints:
- Проверяет health check
- Отправляет тестовые запросы create/update/delete
- Требует наличие JSON файлов с примерами

### init_services.py
Скрипт для инициализации базовых услуг:
- Добавляет стандартный набор услуг в БД
- Проверяет существующие услуги перед добавлением
- Базовые услуги: Уборка, Доставка продуктов, Трансфер, Дополнительное белье, Завтрак, Ранний заезд, Поздний выезд, Барбекю, Парковка, Детская кроватка
- Использует loguru для логирования
- Запуск: `uv run python init_services.py`

### migrate_old_data.py
Скрипт миграции данных из старой базы данных:
- Читает данные из файлов cells.json и sheets.json (экспорт старой БД)
- Преобразует структуру ячеек в модель Booking новой БД
- Маппинг колонок из старой таблицы:
  - column 1 → begin_date (дата заезда, формат DD.MM.YYYY)
  - column 2 → number_of_days (количество дней)
  - column 3 → end_date (дата выезда, формат DD.MM.YYYY)
  - column 4 → client_fio (ФИО клиента)
  - column 5 → client_phone (телефон клиента)
  - column 6 → amount (общая сумма)
  - column 7 → payment (оплата)
  - column 8 → prepayment (предоплата)
  - column 11 → notes (комментарии)
  - sheet_id → apartment_title (название квартиры из sheets.json)
- Пропускает бронирования с некорректными датами
- Проверяет существование записей перед созданием (по booking_id)
- Использует loguru для логирования процесса и ошибок
- Создает лог миграции в logs/migration.log
- Статистика по завершению: успешно созданных, пропущенных, ошибок
- Запуск: `uv run python migrate_old_data.py`

### docker-compose.yml
Конфигурация для запуска с Docker:
- PostgreSQL контейнер с persistant storage
- FastAPI приложение
- Health checks
- Volume для логов

### Dockerfile
Образ для приложения:
- Python 3.12 slim
- Установка зависимостей
- Multi-stage build для оптимизации размера

### MIGRATION_README.md
Подробная инструкция по миграции данных:
- Описание структуры файлов cells.json и sheets.json
- Подробное описание маппинга колонок старой БД на новую модель
- Пошаговая инструкция по запуску миграции
- Решение типичных проблем
- Информация о логировании и статистике
- Инструкция по откату миграции

