# Архитектура проекта DMD Cottage Sheets

## Описание проекта

FastAPI сервис для управления бронированиями недвижимости с интеграцией через webhook, веб-интерфейсом для просмотра и экспорта данных в Excel.

## Структура проекта

```
raznaradki_realty_calendar/
├── app/
│   ├── __init__.py              # Инициализация пакета приложения
│   ├── main.py                  # Главный файл FastAPI приложения
│   ├── config.py                # Конфигурация из .env файла
│   ├── database.py              # Подключение к PostgreSQL и сессии
│   ├── models.py                # SQLAlchemy модели базы данных
│   ├── schemas.py               # Pydantic схемы для валидации данных
│   ├── crud.py                  # CRUD операции для работы с БД
│   ├── auth.py                  # Базовая аутентификация
│   ├── routers/
│   │   ├── __init__.py          # Инициализация пакета роутеров
│   │   ├── webhook.py           # Endpoint для webhook
│   │   ├── web.py               # Web UI endpoints
│   │   └── payments.py          # Endpoints для поступлений денег
│   ├── static/
│   │   └── js/
│   │       ├── bookings.js      # JavaScript для страницы бронирований
│   │       └── payments.js      # JavaScript для страницы поступлений
│   └── templates/
│       ├── base.html            # Базовый шаблон с Bootstrap
│       ├── login.html           # Страница входа
│       ├── bookings.html        # Таблица бронирований
│       └── payments.html        # Таблица поступлений денег
├── logs/                        # Директория для логов
├── cells.json                   # Экспорт таблицы cells из старой БД (для миграции)
├── sheets.json                  # Экспорт таблицы sheets из старой БД (для миграции)
├── migrate_old_data.py          # Скрипт миграции данных из старой БД
├── migrate_client_id_nullable.py # Скрипт миграции client_id на nullable
├── init_services.py             # Скрипт инициализации базовых услуг
├── .env                         # Переменные окружения (не в git)
├── .env.example                 # Пример переменных окружения
├── .gitignore                   # Файлы, игнорируемые git
├── pyproject.toml               # Зависимости проекта
├── README.md                    # Документация проекта
├── MIGRATION_README.md          # Инструкция по миграции данных из старой БД
├── MIGRATION_CLIENT_ID.md       # Инструкция по миграции client_id на nullable
└── architecture.md              # Этот файл - описание архитектуры
```

## Описание файлов

### app/main.py
Главный файл приложения FastAPI:
- Создание экземпляра FastAPI приложения
- Настройка логирования через loguru (консоль + файл)
- **Exception handler для RequestValidationError (422)**:
  - Детальное логирование всех ошибок валидации запросов
  - Логирует URL, метод, клиента, детали ошибок валидации
  - Логирует raw body и form data для отладки
  - Возвращает JSON с деталями ошибки
- Lifecycle management (инициализация БД при запуске)
- Подключение статических файлов (/static)
- Подключение роутеров (webhook, web, payments)
- Health check endpoint

### app/config.py
Управление конфигурацией:
- Класс Settings на базе Pydantic для загрузки переменных из .env
- Функция get_settings() с кешированием настроек
- Переменные: DATABASE_URL, ADMIN_USERNAME, ADMIN_PASSWORD, SECRET_KEY

### app/database.py
Настройка подключения к PostgreSQL:
- Создание engine для SQLAlchemy
- Фабрика сессий SessionLocal
- Базовый класс Base для моделей
- Dependency get_db() для получения сессии БД
- Функция init_db() для создания таблиц

### app/routers/payments.py
Роутер для управления поступлениями денег:
- **check_auth()** - проверка авторизации через session_token cookie, сравнивает с settings.secret_key (внутренняя функция)
- **GET /payments** - страница с таблицей поступлений денег (требует авторизацию)
  - Параметры: filter_date (одна дата) или filter_date_from и filter_date_to (диапазон)
  - Объединяет данные из двух источников:
    1. Реальные поступления из таблицы payments
    2. Услуги из таблицы booking_services (отображаются автоматически)
  - Услуги из booking_services выделяются серым фоном и помечены "Услуга" в колонке действий
  - Автоматический расчет суммы аванса на будущие заселения
  - Расчет плана/факта в шапке таблицы (только по реальным поступлениям)
- **POST /payments/create** - создать новое поступление (требует авторизацию)
  - Принимает данные формы (все как строки): booking_id, booking_service_id, apartment_title, receipt_date, receipt_time, amount, advance_for_future, operation_type, income_category, comment
  - Автоматическая обработка пустых строк: пустые строки преобразуются в None
  - Логика: если указан booking_id и apartment_title пустой, то apartment_title берется из бронирования автоматически
  - Возвращает JSON с результатом операции
- **GET /payments/list** - получить список поступлений в JSON (требует авторизацию)
  - Параметры filter_date, filter_date_from, filter_date_to, apartment_title для фильтрации
- **PUT /payments/{payment_id}** - обновить поступление (требует авторизацию)
- **DELETE /payments/{payment_id}** - удалить поступление (требует авторизацию)
- **GET /payments/calculate-advance** - рассчитать сумму авансов на будущие заселения (требует авторизацию)
  - Параметры: apartment_title, selected_date
  - Возвращает общую сумму предоплат по будущим бронированиям

### app/models.py
SQLAlchemy модели базы данных:
- **Booking** - модель бронирования с полями:
  - Основные: id, action, status
  - Даты: begin_date, end_date
  - ID связей: realty_id, client_id (nullable, может быть None при удалении)
  - Финансы: amount, prepayment, payment
  - Время: arrival_time, departure_time
  - Клиент: client_fio, client_phone, client_email
  - Квартира: apartment_title (индексируется), apartment_address
  - Дополнительно: number_of_days, number_of_nights, notes, checkin_day_comments
  - Флаги: is_delete (индексируется)
  - Временные метки: created_at, updated_at
  - Связи: services (relationship с BookingService)
- **Service** - справочник дополнительных услуг:
  - id: уникальный идентификатор
  - name: название услуги (уникальное)
  - is_active: активна ли услуга
  - created_at, updated_at: временные метки
- **BookingService** - дополнительные услуги к бронированию:
  - id: уникальный идентификатор
  - booking_id: ID бронирования (FK)
  - service_id: ID услуги (FK)
  - price: цена услуги
  - created_at: дата добавления
- **Payment** - модель поступлений денег:
  - id: уникальный идентификатор
  - booking_id: ID бронирования (FK -> bookings.id, SET NULL при удалении, опционально)
  - booking_service_id: ID услуги бронирования (FK -> booking_services.id, SET NULL при удалении, опционально)
  - apartment_title: название объекта недвижимости (опционально, берется из booking если указан booking_id)
  - realty_id: ID недвижимости (опционально)
  - receipt_date: дата поступления (индексируется)
  - receipt_time: время поступления (опционально)
  - amount: сумма поступления
  - advance_for_future: сумма аванса на будущее заселение (опционально)
  - operation_type: тип операции (наличные, безналичный расчет и т.д., опционально)
  - income_category: статья поступления (название услуги или другая категория, опционально)
  - comment: комментарий (опционально)
  - created_at, updated_at: временные метки
  - Связи: booking (many-to-one), booking_service (many-to-one)

### app/schemas.py
Pydantic схемы для валидации данных:
- **ServiceCreate** - создание услуги (name)
- **ServiceResponse** - ответ с услугой (id, name, is_active, created_at)
- **BookingServiceCreate** - добавление услуги к бронированию (booking_id, service_id, price)
- **BookingServiceResponse** - ответ с услугой бронирования (id, booking_id, service_id, price, service_name, created_at)
- **ClientSchema** - данные клиента (id, fio, email, phone); игнорирует дополнительные поля
- **ApartmentSchema** - данные квартиры (id, title, address); игнорирует дополнительные поля
- **BookingSchema** - данные бронирования (все поля модели); client_id и client опциональные (могут быть None при удалении бронирования); игнорирует дополнительные поля (payments_with_deleted, url и т.д.)
- **WebhookDataSchema** - обертка для booking; игнорирует дополнительные поля
- **WebhookPayloadSchema** - payload webhook (action, status, data); игнорирует дополнительные поля (changes, crm_entity_id и т.д.)
- **WebhookRequestSchema** - алиас для WebhookPayloadSchema (данные приходят напрямую без обёртки body)
- **PaymentCreate** - создание поступления (все поля опциональные кроме receipt_date и amount: booking_id, booking_service_id, apartment_title, receipt_date, receipt_time, amount, advance_for_future, operation_type, income_category, comment)
- **PaymentUpdate** - обновление поступления (все поля опциональные)
- **PaymentResponse** - ответ с поступлением (все поля модели Payment, включая booking_id и booking_service_id, apartment_title может быть None)

### app/crud.py
CRUD операции для работы с базой данных:
- **create_or_update_booking()** - создает новое или обновляет существующее бронирование; корректно обрабатывает случай когда client = None (при удалении бронирования)
- **mark_booking_as_deleted()** - помечает бронирование как удаленное
- **get_bookings()** - получает список бронирований с фильтрацией по дате:
  - Фильтр по дате выбирает бронирования где указанная дата является датой заселения (begin_date) ИЛИ датой выселения (end_date)
  - Возвращает только не удаленные бронирования
- **get_booking_by_id()** - получает бронирование по ID
- **get_unique_apartments()** - получает список уникальных объектов недвижимости (DISTINCT запрос, оптимизирован)
- **get_grouped_bookings()** - группирует бронирования по apartment_title и дате для отображения:
  - Использует apartment_title (название квартиры) для поля address
  - Объединяет выселение и заселение на один адрес в одну строку
  - Определяет статус автоматически на основе совпадения дат:
    - Проверяется совпадение filter_date с датами бронирования
    - Если filter_date == end_date → это выселение (checkout)
    - Если filter_date == begin_date → это заселение (checkin)
    - Если обе даты совпадают → Выс/Зас
    - Если filter_date не задан → все бронирования считаются заселением
  - Ключ группировки: (apartment_title, filter_date) - объединяет записи с одним адресом на одну дату
  - Пропускает бронирования, которые не относятся к выбранной дате (не заселение и не выселение)
  - Группирует дубли (например "00) 29" и "00) 29 ДУБЛЬ") вместе и размещает их рядом
  - Сортирует данные: сначала по адресу (алфавитный порядок A-Z, регистронезависимо), затем по дате (новые первыми)
  - Помечает строки флагами для жирных границ: is_first_in_group, is_last_in_group, is_single_row, has_duplicate
  - Жирные границы применяются только к группам дублей (сверху первой и снизу последней строки группы)
  - Между строками дублей внутри группы остаются обычные границы
  - Возвращает словарь с полями: address, date, checkout, checkin, is_first_in_group, is_last_in_group, is_single_row, has_duplicate
- **update_checkin_day_comments()** - обновляет комментарии по оплате и проживанию в день заселения для конкретного бронирования
- **get_all_services()** - получает список всех активных услуг
- **create_service()** - создает новую услугу
- **get_booking_services()** - получает все услуги для конкретного бронирования
- **add_booking_service()** - добавляет услугу к бронированию
- **delete_booking_service()** - удаляет услугу из бронирования
- **get_booking_services_total()** - получает общую сумму услуг для бронирования
- **create_payment()** - создает новое поступление
- **get_payments()** - получает список поступлений с фильтрацией по дате/диапазону дат и объекту
  - Поддерживает фильтрацию по одной дате (filter_date) или по диапазону (filter_date_from, filter_date_to)
  - Загружает связанные данные из booking_service и service для отображения названия услуги в таблице
  - Использует joinedload для оптимизации загрузки связанных сущностей
- **get_payment_by_id()** - получает поступление по ID
- **update_payment()** - обновляет поступление
- **delete_payment()** - удаляет поступление
- **calculate_advance_for_future_bookings()** - рассчитывает сумму авансов на будущие заселения после указанной даты для конкретного объекта
- **get_bookings_with_services()** - получает бронирования с их услугами для отображения в форме поступлений
  - Оптимизировано с использованием joinedload для избежания N+1 проблемы
  - Загружает бронирования со всеми связанными услугами одним запросом
- **get_booking_services_as_payments()** - получает все услуги из booking_services в формате поступлений
  - Фильтрация по дате заселения бронирования (begin_date), которая используется как дата поступления
  - Фильтр работает так же как для обычных поступлений: одна дата (filter_date) или диапазон (filter_date_from, filter_date_to)
  - Преобразует услуги в формат словаря с полями: id, booking_id, booking_service_id, apartment_title, receipt_date, amount, income_category
  - Флаг is_from_booking_service=True для идентификации источника данных
  - Используется для автоматического отображения услуг в таблице поступлений
  - Оптимизировано: один JOIN запрос вместо двух отдельных

### app/auth.py
Система аутентификации:
- **verify_credentials()** - проверка HTTP Basic Auth (для API endpoints)
- **create_session_cookie()** - создание session cookie после входа
- Примечание: для веб-страниц используется функция check_auth() в web.py

### app/routers/webhook.py
Роутер для webhook endpoints:
- **POST /webhook** - прием данных о бронированиях
  - Обрабатывает массив объектов или один объект
  - Поддерживает action: create_booking, update_booking, delete_booking
  - Валидация через Pydantic схемы
  - Сохранение в БД через CRUD функции

### app/routers/web.py
Роутер для веб-интерфейса:
- **check_auth()** - проверка авторизации через cookie (внутренняя функция)
- **GET /** - редирект на /bookings
- **GET /login** - страница входа
- **POST /login** - обработка формы входа
- **GET /logout** - выход из системы
- **GET /bookings** - страница с таблицей бронирований (требует авторизацию)
  - Проверяет авторизацию и редиректит на /login если не авторизован
  - Параметр filter_date для фильтрации: показывает бронирования где выбранная дата является датой заселения ИЛИ выселения
  - Использует get_grouped_bookings() для группировки данных
  - Отображает выселение и заселение в одной строке для одного адреса
  - Редактируемая колонка "Комментарии по оплате и проживанию в день заселения" с автосохранением
  - Колонка "Доп. услуги" с суммой услуг и модальным окном для управления
- **POST /update-checkin-comment** - обновление комментария по оплате и проживанию (требует авторизацию)
  - Принимает booking_id и comments через форму
  - Обновляет поле checkin_day_comments в БД
  - Возвращает JSON с результатом операции
- **GET /services** - получить список всех активных услуг (требует авторизацию)
- **GET /booking-services/{booking_id}** - получить услуги для бронирования (требует авторизацию)
  - Возвращает список услуг и общую сумму
- **POST /booking-services** - добавить услугу к бронированию (требует авторизацию)
  - Принимает booking_id, service_id, price через форму
  - Возвращает JSON с результатом операции
- **DELETE /booking-services/{booking_service_id}** - удалить услугу из бронирования (требует авторизацию)
- **GET /export** - экспорт в Excel (требует авторизацию)
  - Проверяет авторизацию и редиректит на /login если не авторизован
  - Создает Excel файл с помощью openpyxl
  - Использует get_grouped_bookings() для группировки данных
  - Двухуровневая структура заголовков:
    - Уровень 1: Дата заезда (A1:B1), Выселение (C1:E1), Заселение (F1:O1)
    - Уровень 2: Адрес, Статус дома, ФИО (выс), Телефон (выс), Комментарий (выс), ФИО (зас), Телефон (зас), Дата выселения, Кол-во дней, Общая сумма, Предоплата, Доплата, Доп. услуги, Комментарий (зас), Комментарии по оплате и проживанию в день заселения
  - Данные разделены по секциям выселения и заселения
  - Включает сумму дополнительных услуг для каждого бронирования
  - **Стилизация Excel**:
    - Первая строка заголовков: фон rgb(245, 245, 245), жирный шрифт
    - Вторая строка заголовков - цветовое кодирование:
      - "Адрес", "Статус дома": фон rgb(245, 245, 245)
      - Колонки "Выселение" (3-5): бледно-красный (#ffcccc)
      - Колонки "Заселение" (6-15): бледно-зеленый (#ccffcc)
    - Жирные границы (thick): слева от колонок 3 и 6, под второй строкой заголовков
    - **Колонка "Адрес"**: apartment_title в верхнем регистре (UPPERCASE) жирным шрифтом
    - **Колонки "Общая сумма" (10) и "Доплата" (12)**: жирный шрифт для данных
    - **Группировка дублей**: строки с дублями (например "00) 29" и "00) 29 ДУБЛЬ") располагаются рядом и выделяются жирными границами сверху первой строки группы и снизу последней строки группы; внутри группы между дублями границы обычные; одиночные строки без дублей имеют обычные границы
    - Границы для всех ячеек, выравнивание по центру для заголовков
  - Возвращает файл через StreamingResponse

### app/templates/payments.html
Страница с таблицей поступлений денег:
- **Шапка План/Факт**:
  - План на месяц
  - Факт реального заселения
  - Остаток до выполнения плана
  - Общая сумма аванса на будущие заселения (выделена зеленым фоном)
- **Форма фильтрации по диапазону дат**:
  - Поле "Дата с" (filter_date_from) - начало диапазона
  - Поле "Дата по" (filter_date_to) - конец диапазона
  - Кнопки: Фильтровать, Сбросить
- Кнопка добавления нового поступления
- Таблица с колонками:
  - Объект, Дата поступления, Время поступления
  - Сумма поступления, Сумма аванса на будущее заселение (выделяется зеленым)
  - Тип операции, Статья поступления, Комментарий, Действия
  - **Колонка "Статья поступления"**: отображает название услуги из booking_service.service.name если поступление связано с booking_service_id, иначе отображает значение income_category
  - **Два типа строк**:
    1. Реальные поступления (белый фон) - с кнопкой удаления
    2. Услуги из booking_services (серый фон) - помечены "Услуга", нельзя удалить
- Модальное окно для добавления поступления:
  - Выбор бронирования из списка (с информацией об объекте, дате и клиенте)
  - Выбор услуги бронирования (загружаются динамически при выборе бронирования)
  - Поле объекта (автозаполняется при выборе бронирования)
  - Поля даты и времени поступления
  - Поле суммы поступления (автозаполняется при выборе услуги)
  - Поле суммы аванса с кнопкой автоматического расчета
  - Поля типа операции и статьи поступления (с автодополнением, статья автозаполняется при выборе услуги)
  - Поле комментария
- Кнопка удаления для каждого поступления
- Форматирование сумм с разделителем тысяч
- Уведомления об успехе/ошибке операций
- Подключает JavaScript файл payments.js

### app/static/js/payments.js
JavaScript для страницы поступлений:
- **initBookingSelect()** - инициализация выбора бронирования
  - При выборе бронирования загружает список его услуг
  - Автозаполнение поля объекта (apartment_title)
  - Динамическое создание опций в селекте услуг с ценами
  - При выборе услуги автозаполняет сумму и статью поступления
- **initAddPaymentForm()** - инициализация формы добавления поступления
  - Очистка пустых строк для опциональных числовых полей (booking_id, booking_service_id, advance_for_future)
  - Отправка формы через AJAX на /payments/create
  - Включает booking_id и booking_service_id в запрос
  - Перезагрузка страницы после успешного создания
- **initDeleteButtons()** - инициализация кнопок удаления
  - Подтверждение удаления
  - Удаление строки из таблицы без перезагрузки
  - AJAX запрос на DELETE /payments/{payment_id}
- **initCalculateAdvance()** - инициализация кнопки расчета аванса
  - Проверка заполнения объекта и даты
  - AJAX запрос на GET /payments/calculate-advance
  - Автоматическое заполнение поля advance_for_future
- **formatNumber()** - форматирование чисел с разделителем тысяч
- **showNotification()** - показ всплывающих уведомлений
  - Автоматическое скрытие через 5 секунд

### app/templates/base.html
Базовый HTML шаблон:
- Bootstrap 5 для стилизации
- Bootstrap Icons для иконок
- Навигационная панель с вкладками:
  - Бронирования
  - Поступления (новая вкладка)
  - Выход
- Блоки для расширения (content, extra_css, extra_js)

### app/templates/login.html
Страница входа:
- Форма с полями username и password
- Отображение ошибок входа
- Наследуется от base.html

### app/static/js/bookings.js
JavaScript для страницы бронирований:
- **Изменение размера столбцов**:
  - Добавляет интерактивные ресайзеры на правые границы заголовков столбцов
  - Сохраняет размеры столбцов в localStorage (ключ: bookings_table_column_widths)
  - Применяет сохраненные размеры при загрузке страницы
  - Стандартные значения ширины столбцов (в пикселях): [97, 100, 90, 152, 167, 99, 120, 100, 100, 100, 111, 83, 77, 141, 146]
  - Нет минимальной ширины столбцов
  - Динамически пересчитывает ширину таблицы на основе суммы ширин всех столбцов
  - Таблица автоматически адаптируется при изменении размера столбцов в реальном времени
  - Функция сброса ширины столбцов к стандартным значениям (resetColumnWidths)
- **Управление комментариями**:
  - Автосохранение комментариев с визуальными уведомлениями
  - Показ/скрытие кнопки сохранения при изменении текста
- **Управление дополнительными услугами**:
  - Форматирование чисел с разделителем тысяч (formatNumber)
  - Загрузка списка доступных услуг
  - Загрузка сумм услуг для всех бронирований
  - Popover с детализацией услуг при наведении
  - Модальное окно для добавления/удаления услуг
  - AJAX запросы для работы с услугами
- **Уведомления**:
  - Показ всплывающих уведомлений (success, danger, warning)
  - Автоматическое скрытие через 3 секунды

### app/templates/bookings.html
Страница с таблицей бронирований:
- Форма фильтрации по дате заезда
- Кнопки: Фильтровать, Сбросить, Экспорт в Excel, Сбросить ширину столбцов
- Таблица с двумя уровнями заголовков (идентична экспорту):
  - Уровень 1: Дата заезда (colspan=2), Выселение (colspan=3), Заселение (colspan=10)
  - Уровень 2: Адрес, Статус дома, ФИО (выс), Телефон (выс), Комментарий (выс), ФИО (зас), Телефон (зас), Дата выселения, Кол-во дней, Общая сумма, Предоплата, Доплата, Доп. услуги, Комментарий (зас), Комментарии по оплате и проживанию в день заселения
- ID скрыт из таблицы
- Даты в формате dd.mm.yyyy
- Статусы: "Заселение", "Выселение", "Выс/Зас"
- Финансовые данные без копеек
- Группировка: данные по одному apartment_title и дате в одной строке
- Секции выселения и заселения отображаются в зависимости от статуса
- Единый формат таблицы для UI и экспорта
- **Изменение размера столбцов**:
  - Каждый столбец можно растягивать/сжимать мышью за правый край заголовка
  - Стандартные значения ширины столбцов: [97, 100, 90, 152, 167, 99, 120, 100, 100, 100, 111, 83, 77, 141, 146]
  - Размеры столбцов сохраняются в localStorage браузера
  - Нет минимальной ширины столбцов
  - Ширина таблицы динамически изменяется на основе суммы ширин всех столбцов
  - Таблица не растянута на всю страницу, имеет точную ширину по содержимому
  - Кнопка "Сбросить ширину столбцов" для возврата к стандартным значениям
- **Стилизация таблицы**:
  - Первая строка заголовков: фон rgb(245, 245, 245)
  - Вторая строка заголовков - цветовое кодирование:
    - "Адрес", "Статус дома": фон rgb(245, 245, 245)
    - Колонки "Выселение": бледно-красный фон (#ffcccc)
    - Колонки "Заселение": бледно-зеленый фон (#ccffcc)
  - Жирные границы (3px): слева от "Выселение", слева от "Заселение", под второй строкой заголовков
  - **Колонки "Общая сумма" и "Доплата"**: жирный шрифт
  - **Группировка дублей**: строки с дублями (например "00) 29" и "00) 29 ДУБЛЬ") располагаются рядом и выделяются жирными границами сверху первой строки группы и снизу последней строки группы; внутри группы между дублями границы обычные; одиночные строки без дублей имеют обычные границы
- **Колонка "Адрес"**: отображает apartment_title в верхнем регистре (UPPERCASE) жирным шрифтом
- **Редактируемая колонка**: "Комментарии по оплате и проживанию в день заселения" с textarea и кнопкой сохранения
- **Колонка "Доп. услуги"**:
  - Отображает общую сумму дополнительных услуг в формате с разделителем тысяч (10,000) без значка рубля
  - При клике открывает модальное окно для управления услугами
  - Модальное окно содержит:
    - Форму добавления услуги (выбор из выпадающего списка, ввод цены)
    - Список добавленных услуг с возможностью удаления (цены в формате с разделителем, без ₽)
    - Общую сумму всех услуг (в формате с разделителем, без ₽)
- Подключает внешний JavaScript файл bookings.js

## API Endpoints

### Webhook API

#### POST /webhook
Прием webhook данных о бронированиях.

**Request Body (массив или один объект):**
```json
[{
  "action": "create_booking",
  "status": "booked",
  "data": {
    "booking": {
      "id": 122913631,
      "begin_date": "2025-10-13",
      "end_date": "2025-10-14",
      "client": {...},
      "apartment": {...},
      ...
    }
  }
}]
```

**Response:**
```json
{
  "status": "success",
  "processed": 1,
  "results": [...]
}
```

### Web API

#### GET /
Редирект на /bookings

#### GET /login
Страница входа

#### POST /login
Обработка формы входа
- Form data: username, password

#### GET /logout
Выход из системы

#### GET /bookings
Страница бронирований
- Query параметр: `filter_date` (YYYY-MM-DD) - показывает бронирования где указанная дата является датой заселения ИЛИ выселения
- Требует: авторизация через cookie

#### POST /update-checkin-comment
Обновление комментария по оплате и проживанию
- Form data: `booking_id`, `comments`
- Требует: авторизация через cookie
- Response: JSON `{"status": "success", "message": "..."}`

#### GET /services
Получить список всех активных услуг
- Требует: авторизация через cookie
- Response: JSON `{"services": [{"id": 1, "name": "Услуга"}]}`

#### GET /booking-services/{booking_id}
Получить услуги для конкретного бронирования
- Path параметр: `booking_id`
- Требует: авторизация через cookie
- Response: JSON `{"services": [...], "total": 1000.0}`

#### POST /booking-services
Добавить услугу к бронированию
- Form data: `booking_id`, `service_id`, `price`
- Требует: авторизация через cookie
- Response: JSON `{"status": "success", "message": "...", "id": 1}`

#### DELETE /booking-services/{booking_service_id}
Удалить услугу из бронирования
- Path параметр: `booking_service_id`
- Требует: авторизация через cookie
- Response: JSON `{"status": "success", "message": "..."}`

#### GET /export
Экспорт в Excel
- Query параметр: `filter_date` (YYYY-MM-DD)
- Требует: авторизация через cookie
- Response: Excel файл

### Payments API

#### GET /payments
Страница поступлений денег
- Query параметры: 
  - `filter_date` (YYYY-MM-DD) - фильтр по одной дате поступления
  - `filter_date_from` (YYYY-MM-DD) - начало диапазона дат
  - `filter_date_to` (YYYY-MM-DD) - конец диапазона дат
- Можно использовать либо `filter_date`, либо `filter_date_from` и `filter_date_to`
- Требует: авторизация через cookie

#### POST /payments/create
Создать новое поступление
- Form data (все поля как строки): `booking_id`, `booking_service_id`, `apartment_title`, `receipt_date`, `receipt_time`, `amount`, `advance_for_future`, `operation_type`, `income_category`, `comment`
- Обработка данных:
  - Пустые строки автоматически преобразуются в None
  - Числовые поля (booking_id, booking_service_id, amount, advance_for_future) парсятся на сервере
  - Если указан `booking_id` и `apartment_title` пустой, то `apartment_title` берется из бронирования автоматически
- Требует: авторизация через cookie
- Response: JSON `{"status": "success", "message": "...", "id": 1}`

#### GET /payments/list
Получить список поступлений в JSON
- Query параметры: 
  - `filter_date` (YYYY-MM-DD) - фильтр по одной дате
  - `filter_date_from` (YYYY-MM-DD) - начало диапазона
  - `filter_date_to` (YYYY-MM-DD) - конец диапазона
  - `apartment_title` - фильтр по объекту
- Можно использовать либо `filter_date`, либо `filter_date_from` и `filter_date_to`
- Требует: авторизация через cookie
- Response: JSON `{"payments": [...]}`

#### PUT /payments/{payment_id}
Обновить поступление
- Path параметр: `payment_id`
- Form data: поля для обновления (все опциональные)
- Требует: авторизация через cookie
- Response: JSON `{"status": "success", "message": "..."}`

#### DELETE /payments/{payment_id}
Удалить поступление
- Path параметр: `payment_id`
- Требует: авторизация через cookie
- Response: JSON `{"status": "success", "message": "..."}`

#### GET /payments/calculate-advance
Рассчитать сумму авансов на будущие заселения
- Query параметры: `apartment_title`, `selected_date`
- Требует: авторизация через cookie
- Response: JSON `{"status": "success", "total_advance": 10000.0}`

#### GET /health
Health check endpoint
```json
{"status": "ok", "service": "DMD Cottage Sheets"}
```

## База данных

### Таблица: bookings

| Поле | Тип | Описание |
|------|-----|----------|
| id | Integer (PK) | ID бронирования из webhook |
| action | String | Действие: create_booking, update_booking, delete_booking |
| status | String | Статус: booked, deleted |
| begin_date | Date | Дата заезда (индексируется) |
| end_date | Date | Дата выезда |
| realty_id | Integer | ID недвижимости |
| client_id | Integer (nullable) | ID клиента (может быть None при удалении) |
| amount | Numeric(10,2) | Общая сумма |
| prepayment | Numeric(10,2) | Предоплата |
| payment | Numeric(10,2) | Оплата |
| arrival_time | Time | Время заселения |
| departure_time | Time | Время выселения |
| notes | String | Комментарии |
| checkin_day_comments | String | Комментарии по оплате и проживанию в день заселения (редактируемое поле) |
| client_fio | String | ФИО клиента |
| client_phone | String | Телефон клиента |
| client_email | String | Email клиента |
| apartment_title | String | Название квартиры (индексируется для оптимизации) |
| apartment_address | String | Адрес квартиры |
| number_of_days | Integer | Количество дней |
| number_of_nights | Integer | Количество ночей |
| is_delete | Boolean | Флаг удаления (индексируется для быстрой фильтрации) |
| created_at | DateTime | Дата создания записи |
| updated_at | DateTime | Дата обновления записи |
| webhook_created_at | DateTime | Дата создания из webhook |
| webhook_updated_at | DateTime | Дата обновления из webhook |

### Таблица: services

| Поле | Тип | Описание |
|------|-----|----------|
| id | Integer (PK) | Уникальный идентификатор |
| name | String (Unique) | Название услуги |
| is_active | Boolean | Активна ли услуга |
| created_at | DateTime | Дата создания |
| updated_at | DateTime | Дата обновления |

### Таблица: booking_services

| Поле | Тип | Описание |
|------|-----|----------|
| id | Integer (PK) | Уникальный идентификатор |
| booking_id | Integer (FK -> bookings.id) | ID бронирования (индексируется) |
| service_id | Integer (FK -> services.id) | ID услуги (индексируется) |
| price | Numeric(10,2) | Цена услуги |
| created_at | DateTime | Дата добавления |

**Связи:**
- bookings.services -> booking_services (one-to-many, cascade delete)
- services.booking_services -> booking_services (one-to-many, cascade delete)
- booking_services.booking -> bookings (many-to-one)
- booking_services.service -> services (many-to-one)

### Таблица: payments

| Поле | Тип | Описание |
|------|-----|----------|
| id | Integer (PK) | Уникальный идентификатор |
| booking_id | Integer (FK -> bookings.id) | ID бронирования (индексируется, SET NULL при удалении, nullable) |
| booking_service_id | Integer (FK -> booking_services.id) | ID услуги бронирования (индексируется, SET NULL при удалении, nullable) |
| apartment_title | String | Название объекта недвижимости (nullable, берется из booking если указан booking_id) |
| realty_id | Integer | ID недвижимости (nullable) |
| receipt_date | Date | Дата поступления (индексируется, NOT NULL) |
| receipt_time | Time | Время поступления (nullable) |
| amount | Numeric(10,2) | Сумма поступления (NOT NULL) |
| advance_for_future | Numeric(10,2) | Сумма аванса на будущее заселение (nullable) |
| operation_type | String | Тип операции (наличные, безналичный расчет и т.д., nullable) |
| income_category | String | Статья поступления (название услуги или другая категория, nullable) |
| comment | String | Комментарий (nullable) |
| created_at | DateTime | Дата создания записи |
| updated_at | DateTime | Дата обновления записи |

**Связи:**
- payments.booking -> bookings (many-to-one)
- payments.booking_service -> booking_services (many-to-one)

**Функциональность:**
- Учет всех денежных поступлений по объектам недвижимости
- Связь поступлений с конкретными бронированиями и их услугами
- Автоматическое заполнение данных при выборе бронирования и услуги
- Автоматический расчет суммы авансов на будущие заселения
- Фильтрация по дате поступления и объекту
- Типизация операций и статей поступления

## Зависимости

- **fastapi** - веб-фреймворк
- **uvicorn** - ASGI сервер
- **sqlalchemy** - ORM для работы с БД
- **psycopg2-binary** - драйвер PostgreSQL
- **python-dotenv** - загрузка переменных из .env
- **pydantic-settings** - управление настройками
- **jinja2** - шаблонизатор для HTML
- **python-multipart** - обработка форм
- **openpyxl** - создание Excel файлов
- **loguru** - логирование

## Переменные окружения (.env)

```env
DATABASE_URL=postgresql://user:password@localhost:5432/realty_calendar
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin
SECRET_KEY=your-secret-key-change-this-in-production
```

## Логирование

Используется библиотека **loguru**:
- Вывод в консоль с цветной подсветкой
- Запись в файл `logs/app.log`
- Ротация файлов при достижении 10 MB
- Хранение логов 30 дней
- Сжатие старых логов в zip

## Безопасность

- Базовая HTTP Basic Auth для проверки учетных данных
- Session cookie для поддержания сеанса
- HTTPOnly cookies для защиты от XSS
- Учетные данные хранятся в .env файле
- .env файл в .gitignore

## Использование

### Запуск приложения

```bash
# Установка uv (если еще не установлен)
curl -LsSf https://astral.sh/uv/install.sh | sh

# Синхронизация зависимостей
uv sync

# Настройка .env файла (уже создан, отредактируйте при необходимости)
vim .env

# Запуск сервера
uv run raznaradki_main.py

# Или через скрипт
./run.sh
```

Приложение будет доступно на `http://localhost:8000`

### Доступ к веб-интерфейсу

1. Открыть `http://localhost:8000`
2. Войти с учетными данными из .env (по умолчанию admin/admin)
3. Просматривать и фильтровать бронирования
4. Экспортировать в Excel

### Отправка webhook

```bash
curl -X POST http://localhost:8000/webhook \
  -H "Content-Type: application/json" \
  -d @create_booking.json
```

## Развертывание

### Локальное развертывание

1. Настроить PostgreSQL базу данных
2. Создать .env файл с реальными учетными данными
3. Установить зависимости: `pip install -e .`
4. Запустить приложение: `./run.sh` или `python -m app.main`
5. Таблицы создадутся автоматически при старте

### Docker развертывание

Самый простой способ запуска с PostgreSQL:

```bash
# Запуск всех сервисов
docker-compose up -d

# Просмотр логов
docker-compose logs -f app

# Остановка
docker-compose down
```

Приложение будет доступно на `http://localhost:8000`

### Production развертывание

1. Используйте управляемую PostgreSQL базу данных
2. Настройте .env с безопасными учетными данными
3. Используйте reverse proxy (nginx)
4. Включите SSL/TLS
5. Настройте firewall
6. Используйте process manager (systemd, supervisor)
7. Настройте мониторинг и алертинг

## Оптимизация производительности

Для ускорения работы приложения применены следующие оптимизации:

### Индексы БД
- **bookings.apartment_title** - индексируется для быстрого поиска по объектам
- **bookings.is_delete** - индексируется для быстрой фильтрации активных бронирований
- **bookings.begin_date** - индексируется для фильтрации по датам заселения
- **payments.receipt_date** - индексируется для фильтрации поступлений по датам

### Оптимизация запросов
1. **get_unique_apartments()** - использует SELECT DISTINCT вместо загрузки 10000+ записей
2. **get_bookings_with_services()** - использует joinedload для предзагрузки связанных данных (избегает N+1)
3. **get_booking_services_as_payments()** - один JOIN запрос вместо двух отдельных запросов
4. **get_payments()** - использует joinedload для предзагрузки booking_service и service

### Результат
- Время обработки запросов к `/payments` с диапазоном дат уменьшилось с ~5 секунд до < 1 секунды
- Количество SQL запросов сократилось с N+1 до 1-3 запросов на страницу
- Использование памяти снизилось за счет отказа от загрузки всех записей

## Дополнительные файлы

### add_indexes_migration.py
Скрипт миграции для добавления индексов в существующую БД:
- Добавляет индексы на apartment_title и is_delete в таблице bookings
- Проверяет существование индексов перед созданием
- Использует loguru для логирования процесса
- Создает лог в logs/migration_indexes.log
- Безопасно обрабатывает ошибки с rollback
- Запуск: `uv run python add_indexes_migration.py`

### migrate_client_id_nullable.py
Скрипт миграции для изменения поля client_id на nullable:
- Изменяет поле client_id в таблице bookings с NOT NULL на NULL
- Необходимо для корректной обработки webhook при удалении бронирования (client_id может быть None)
- Проверяет текущее состояние поля перед миграцией
- Использует loguru для логирования процесса
- Создает лог в logs/migration_client_id_YYYYMMDD_HHMMSS.log
- Запуск: `uv run python migrate_client_id_nullable.py`

### run.sh
Скрипт для запуска приложения:
- Проверяет наличие .env
- Устанавливает зависимости при необходимости
- Запускает приложение

### test_webhook.sh
Скрипт для тестирования webhook endpoints:
- Проверяет health check
- Отправляет тестовые запросы create/update/delete
- Требует наличие JSON файлов с примерами

### init_services.py
Скрипт для инициализации базовых услуг:
- Добавляет стандартный набор услуг в БД
- Проверяет существующие услуги перед добавлением
- Базовые услуги: Уборка, Доставка продуктов, Трансфер, Дополнительное белье, Завтрак, Ранний заезд, Поздний выезд, Барбекю, Парковка, Детская кроватка
- Использует loguru для логирования
- Запуск: `uv run python init_services.py`

### migrate_old_data.py
Скрипт миграции данных из старой базы данных:
- Читает данные из файлов cells.json и sheets.json (экспорт старой БД)
- Преобразует структуру ячеек в модель Booking новой БД
- Маппинг колонок из старой таблицы:
  - column 1 → begin_date (дата заезда, формат DD.MM.YYYY)
  - column 2 → number_of_days (количество дней)
  - column 3 → end_date (дата выезда, формат DD.MM.YYYY)
  - column 4 → client_fio (ФИО клиента)
  - column 5 → client_phone (телефон клиента)
  - column 6 → amount (общая сумма)
  - column 7 → payment (оплата)
  - column 8 → prepayment (предоплата)
  - column 11 → notes (комментарии)
  - sheet_id → apartment_title (название квартиры из sheets.json)
- Пропускает бронирования с некорректными датами
- Проверяет существование записей перед созданием (по booking_id)
- Использует loguru для логирования процесса и ошибок
- Создает лог миграции в logs/migration.log
- Статистика по завершению: успешно созданных, пропущенных, ошибок
- Запуск: `uv run python migrate_old_data.py`

### docker-compose.yml
Конфигурация для запуска с Docker:
- PostgreSQL контейнер с persistant storage
- FastAPI приложение
- Health checks
- Volume для логов

### Dockerfile
Образ для приложения:
- Python 3.12 slim
- Установка зависимостей
- Multi-stage build для оптимизации размера

### MIGRATION_README.md
Подробная инструкция по миграции данных:
- Описание структуры файлов cells.json и sheets.json
- Подробное описание маппинга колонок старой БД на новую модель
- Пошаговая инструкция по запуску миграции
- Решение типичных проблем
- Информация о логировании и статистике
- Инструкция по откату миграции

### MIGRATION_CLIENT_ID.md
Инструкция по миграции поля client_id на nullable:
- Описание зачем нужна миграция (обработка webhook удаления с client_id = None)
- Когда запускать миграцию (один раз на существующей БД)
- Пошаговая инструкция по запуску
- Описание что делает миграция
- Информация о логировании
- Инструкция по откату (с предупреждением об удалении данных)
- Список связанных изменений в коде

