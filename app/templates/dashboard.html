{% extends "base.html" %}

{% block title %}Дашборд - Разнарядки DMD Cottage{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mt-4 mb-3">Финансовый дашборд за {{ year }} год</h1>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <form method="GET" class="d-inline-block">
                <label for="yearSelect" class="form-label me-2">Год:</label>
                <select name="year" id="yearSelect" class="form-select d-inline-block w-auto"
                    onchange="this.form.submit()" style="width: auto;">
                    {% for y in range(2020, 2031) %}
                    <option value="{{ y }}" {% if y==year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </form>
            <a href="/dashboard/export?year={{ year }}" class="btn btn-success ms-3">
                <i class="bi bi-file-earmark-excel"></i> Экспорт в Excel
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th rowspan="2" class="sticky-col">Объект</th>
                            <th colspan="3" class="text-center">Итого</th>
                            {% for month in range(1, 13) %}
                            <th colspan="3" class="text-center">{{ ['Январь', 'Февраль', 'Март', 'Апрель', 'Май',
                                'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'][month-1] }}</th>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th class="small-header">Доход</th>
                            <th class="small-header">Расход</th>
                            <th class="small-header">Прибыль</th>
                            {% for i in range(12) %}
                            <th class="small-header">Доход</th>
                            <th class="small-header">Расход</th>
                            <th class="small-header">Прибыль</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for base_apartment, apartment_data in get_apartment_summary(financial_data).items() %}
                        <tr>
                            <td class="apartment-cell" {% if apartment_data.apartments|length> 1 %}title="{{
                                apartment_data.apartments|join(', ') }}"{% endif %}>
                                <strong>{{ base_apartment }}</strong>
                            </td>
                            <td class="text-success fw-light small">{{
                                "{:,.0f}".format(apartment_data.total_income)|replace(',', ' ') }}</td>
                            <td class="text-danger fw-light small">{{
                                "{:,.0f}".format(apartment_data.total_expenses)|replace(',', ' ') }}</td>
                            <td
                                class="{% if apartment_data.total_profit >= 0 %}text-success{% else %}text-danger{% endif %} fw-light small">
                                {{ "{:,.0f}".format(apartment_data.total_profit)|replace(',', ' ') }}
                            </td>
                            {% for month in range(1, 13) %}
                            {% set month_key = "{}-{:02d}".format(year, month) %}
                            {% if month_key in financial_data %}
                            {% set month_data = financial_data[month_key] %}
                            {% if base_apartment in month_data.objects %}
                            {% set obj_data = month_data.objects[base_apartment] %}
                            <td class="text-success fw-light small">{{ "{:,.0f}".format(obj_data.income)|replace(',', '
                                ') }}</td>
                            <td class="text-danger fw-light small">{{ "{:,.0f}".format(obj_data.expenses)|replace(',', '
                                ') }}</td>
                            <td
                                class="{% if obj_data.profit >= 0 %}text-success{% else %}text-danger{% endif %} fw-light small">
                                {{ "{:,.0f}".format(obj_data.profit)|replace(',', ' ') }}
                            </td>
                            {% else %}
                            <td class="text-muted">-</td>
                            <td class="text-muted">-</td>
                            <td class="text-muted">-</td>
                            {% endif %}
                            {% else %}
                            <td class="text-muted">-</td>
                            <td class="text-muted">-</td>
                            <td class="text-muted">-</td>
                            {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}

                        <!-- Общие расходы (не привязаны к объектам) -->
                        <tr class="table-warning">
                            <td class="sticky-cell-warning"><strong>Общие расходы</strong></td>
                            <td class="text-muted small">-</td>
                            <td class="text-danger fw-light small">{{
                                "{:,.0f}".format(yearly_totals.total_general_expenses or 0)|replace(',', ' ') }}</td>
                            <td class="text-muted small">-</td>
                            {% for month in range(1, 13) %}
                            {% set month_key = "{}-{:02d}".format(year, month) %}
                            {% if month_key in financial_data %}
                            {% set month_data = financial_data[month_key] %}
                            <td class="text-muted small">-</td>
                            <td class="text-danger fw-light small">{{ "{:,.0f}".format(month_data.general_expenses or
                                0)|replace(',', ' ') }}</td>
                            <td class="text-muted small">-</td>
                            {% else %}
                            <td class="text-muted">-</td>
                            <td class="text-muted">-</td>
                            <td class="text-muted">-</td>
                            {% endif %}
                            {% endfor %}
                        </tr>

                        <!-- Итоговая строка -->
                        <tr class="table-secondary">
                            <td class="sticky-cell-secondary"><strong>ИТОГО</strong></td>
                            <td class="text-success fw-light small">{{
                                "{:,.0f}".format(yearly_totals.total_income)|replace(',', ' ') }}</td>
                            <td class="text-danger fw-light small">{{ "{:,.0f}".format(yearly_totals.total_expenses +
                                (yearly_totals.total_general_expenses or 0))|replace(',', ' ') }}</td>
                            <td
                                class="{% if yearly_totals.total_profit >= (yearly_totals.total_general_expenses or 0) %}text-success{% else %}text-danger{% endif %} fw-light small">
                                {{ "{:,.0f}".format(yearly_totals.total_profit - (yearly_totals.total_general_expenses
                                or 0))|replace(',', ' ') }}
                            </td>
                            {% for month in range(1, 13) %}
                            {% set month_key = "{}-{:02d}".format(year, month) %}
                            {% if month_key in financial_data %}
                            {% set month_data = financial_data[month_key] %}
                            <td class="text-success fw-light small">{{
                                "{:,.0f}".format(month_data.total_income)|replace(',', ' ') }}</td>
                            <td class="text-danger fw-light small">{{ "{:,.0f}".format(month_data.total_expenses +
                                (month_data.general_expenses or 0))|replace(',', ' ') }}</td>
                            <td
                                class="{% if month_data.total_profit >= (month_data.general_expenses or 0) %}text-success{% else %}text-danger{% endif %} fw-light small">
                                {{ "{:,.0f}".format(month_data.total_profit - (month_data.general_expenses or
                                0))|replace(',', ' ') }}
                            </td>
                            {% else %}
                            <td class="text-muted">-</td>
                            <td class="text-muted">-</td>
                            <td class="text-muted">-</td>
                            {% endif %}
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Функция для форматирования чисел с пробелами как разделителями тысяч
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
</script>
{% endblock %}

{% block extra_css %}
<style>
    .table th,
    .table td {
        vertical-align: middle;
        text-align: center;
        padding: 0.3rem 0.4rem;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .table th {
        font-weight: 600;
    }

    h1 {
        font-size: 1.75rem;
    }

    .form-label {
        font-size: 1rem;
        margin-bottom: 0;
    }

    .form-select {
        font-size: 1rem;
        padding: 0.375rem 0.75rem;
    }

    .small-header {
        font-size: 0.75rem !important;
    }

    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        max-width: 100%;
        margin-bottom: 1rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border-radius: 0.25rem;
    }

    /* Apartment hover styles */
    .apartment-cell {
        position: relative;
        cursor: pointer;
        font-weight: 600;
        text-align: left !important;
        min-width: 150px;
        position: sticky;
        left: 0;
        background-color: #fff;
        z-index: 1;
        border-right: 2px solid #dee2e6;
    }

    .apartment-cell:hover {
        background-color: #f8f9fa;
    }

    /* Sticky header for apartment column */
    .table thead th.sticky-col {
        position: sticky;
        left: 0;
        z-index: 2;
        background-color: #f8f9fa;
        border-right: 2px solid #dee2e6;
    }

    /* Sticky cells for footer rows */
    .sticky-cell-warning {
        position: sticky;
        left: 0;
        z-index: 1;
        background-color: #fff3cd;
        /* Bootstrap table-warning color */
        border-right: 2px solid #dee2e6;
    }

    .sticky-cell-secondary {
        position: sticky;
        left: 0;
        z-index: 1;
        background-color: #e2e3e5;
        /* Bootstrap table-secondary color */
        border-right: 2px solid #dee2e6;
    }
</style>
{% endblock %}