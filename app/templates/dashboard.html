{% extends "base.html" %}

{% block title %}Дашборд - Разнарядки DMD Cottage{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mt-4 mb-3">Финансовый дашборд за {{ year }} год</h1>
        </div>
    </div>
    
    <div class="row mb-3">
        <div class="col-12">
            <form method="GET" class="d-inline-block">
                <label for="yearSelect" class="form-label me-2">Год:</label>
                <select name="year" id="yearSelect" class="form-select d-inline-block w-auto" onchange="this.form.submit()" style="width: auto;">
                    {% for y in range(2020, 2031) %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th rowspan="2">Объект</th>
                            <th colspan="3" class="text-center">Итого</th>
                            {% for month in range(1, 13) %}
                                <th colspan="3" class="text-center">{{ ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'][month-1] }}</th>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th class="small">Д</th>
                            <th class="small">Р</th>
                            <th class="small">П</th>
                            {% for i in range(12) %}
                                <th class="small">Д</th>
                                <th class="small">Р</th>
                                <th class="small">П</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for base_apartment, apartment_data in get_apartment_summary(financial_data).items() %}
                        <tr>
                            <td>
                                <strong>{{ base_apartment }}</strong>
                                {% if apartment_data.apartments|length > 1 %}
                                <br><small class="text-muted">({{ apartment_data.apartments|join(', ') }})</small>
                                {% endif %}
                            </td>
                            <td class="text-success fw-light small">{{ "{:,.0f}".format(apartment_data.total_income)|replace(',', ' ') }}</td>
                            <td class="text-danger fw-light small">{{ "{:,.0f}".format(apartment_data.total_expenses)|replace(',', ' ') }}</td>
                            <td class="{% if apartment_data.total_profit >= 0 %}text-success{% else %}text-danger{% endif %} fw-light small">
                                {{ "{:,.0f}".format(apartment_data.total_profit)|replace(',', ' ') }}
                            </td>
                            {% for month in range(1, 13) %}
                                {% set month_key = "{}-{:02d}".format(year, month) %}
                                {% if month_key in financial_data %}
                                    {% set month_data = financial_data[month_key] %}
                                    {% if base_apartment in month_data.objects %}
                                        {% set obj_data = month_data.objects[base_apartment] %}
                                        <td class="text-success fw-light small">{{ "{:,.0f}".format(obj_data.income)|replace(',', ' ') }}</td>
                                        <td class="text-danger fw-light small">{{ "{:,.0f}".format(obj_data.expenses)|replace(',', ' ') }}</td>
                                        <td class="{% if obj_data.profit >= 0 %}text-success{% else %}text-danger{% endif %} fw-light small">
                                            {{ "{:,.0f}".format(obj_data.profit)|replace(',', ' ') }}
                                        </td>
                                    {% else %}
                                        <td class="text-muted">-</td>
                                        <td class="text-muted">-</td>
                                        <td class="text-muted">-</td>
                                    {% endif %}
                                {% else %}
                                    <td class="text-muted">-</td>
                                    <td class="text-muted">-</td>
                                    <td class="text-muted">-</td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        
                        <!-- Общие расходы (не привязаны к объектам) -->
                        <tr class="table-warning">
                            <td><strong>Общие расходы</strong></td>
                            <td class="text-muted small">-</td>
                            <td class="text-danger fw-light small">{{ "{:,.0f}".format(yearly_totals.total_general_expenses or 0)|replace(',', ' ') }}</td>
                            <td class="text-muted small">-</td>
                            {% for month in range(1, 13) %}
                                {% set month_key = "{}-{:02d}".format(year, month) %}
                                {% if month_key in financial_data %}
                                    {% set month_data = financial_data[month_key] %}
                                    <td class="text-muted small">-</td>
                                    <td class="text-danger fw-light small">{{ "{:,.0f}".format(month_data.general_expenses or 0)|replace(',', ' ') }}</td>
                                    <td class="text-muted small">-</td>
                                {% else %}
                                    <td class="text-muted">-</td>
                                    <td class="text-muted">-</td>
                                    <td class="text-muted">-</td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        
                        <!-- Итоговая строка -->
                        <tr class="table-secondary">
                            <td><strong>ИТОГО</strong></td>
                            <td class="text-success fw-light small">{{ "{:,.0f}".format(yearly_totals.total_income)|replace(',', ' ') }}</td>
                            <td class="text-danger fw-light small">{{ "{:,.0f}".format(yearly_totals.total_expenses + (yearly_totals.total_general_expenses or 0))|replace(',', ' ') }}</td>
                            <td class="{% if yearly_totals.total_profit >= (yearly_totals.total_general_expenses or 0) %}text-success{% else %}text-danger{% endif %} fw-light small">
                                {{ "{:,.0f}".format(yearly_totals.total_profit - (yearly_totals.total_general_expenses or 0))|replace(',', ' ') }}
                            </td>
                            {% for month in range(1, 13) %}
                                {% set month_key = "{}-{:02d}".format(year, month) %}
                                {% if month_key in financial_data %}
                                    {% set month_data = financial_data[month_key] %}
                                    <td class="text-success fw-light small">{{ "{:,.0f}".format(month_data.total_income)|replace(',', ' ') }}</td>
                                    <td class="text-danger fw-light small">{{ "{:,.0f}".format(month_data.total_expenses + (month_data.general_expenses or 0))|replace(',', ' ') }}</td>
                                    <td class="{% if month_data.total_profit >= (month_data.general_expenses or 0) %}text-success{% else %}text-danger{% endif %} fw-light small">
                                        {{ "{:,.0f}".format(month_data.total_profit - (month_data.general_expenses or 0))|replace(',', ' ') }}
                                    </td>
                                {% else %}
                                    <td class="text-muted">-</td>
                                    <td class="text-muted">-</td>
                                    <td class="text-muted">-</td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Функция для форматирования чисел с пробелами как разделителями тысяч
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
</script>
{% endblock %}

{% block extra_css %}
<style>
    .table th, .table td {
        vertical-align: middle;
        text-align: center;
        padding: 0.2rem 0.25rem;
        font-size: 0.75rem;
        white-space: nowrap;
    }
    
    .table th {
        font-weight: 500;
    }
    
    h1 {
        font-size: 1.5rem;
    }
    
    .form-label {
        font-size: 0.9rem;
        margin-bottom: 0;
    }
    
    .form-select {
        font-size: 0.9rem;
        padding: 0.25rem 0.5rem;
    }
    
    .small {
        font-size: 0.7rem !important;
    }
    
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
</style>
{% endblock %}